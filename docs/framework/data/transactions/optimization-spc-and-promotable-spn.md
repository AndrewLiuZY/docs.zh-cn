---
title: 使用单阶段提交和可提升的单阶段通知进行优化
description: 使用单阶段提交和可提升的单阶段通知优化性能。 了解 .NET 中的 System. 事务基础结构。
ms.date: 03/30/2017
ms.assetid: 57beaf1a-fb4d-441a-ab1d-bc0c14ce7899
ms.openlocfilehash: 89ce82e673340c93254983c078f78a2501129383
ms.sourcegitcommit: 6219b1e1feccb16d88656444210fed3297f5611e
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 06/22/2020
ms.locfileid: "85141973"
---
# <a name="optimization-using-single-phase-commit-and-promotable-single-phase-notification"></a><span data-ttu-id="9bbf5-104">使用单阶段提交和可提升的单阶段通知进行优化</span><span class="sxs-lookup"><span data-stu-id="9bbf5-104">Optimization using Single Phase Commit and Promotable Single Phase Notification</span></span>

<span data-ttu-id="9bbf5-105">本主题描述 <xref:System.Transactions> 基础结构所提供的用于优化性能的机制。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-105">This topic describes the mechanisms provided by the <xref:System.Transactions> infrastructure to optimize performance.</span></span>

## <a name="promotable-single-phase-enlistment"></a><span data-ttu-id="9bbf5-106">可提升的单阶段登记</span><span class="sxs-lookup"><span data-stu-id="9bbf5-106">Promotable Single Phase Enlistment</span></span>

<span data-ttu-id="9bbf5-107"><xref:System.Transactions> 基础结构在最多包含一个持久资源或包含多个可变资源的单个应用程序域中管理事务。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-107">The <xref:System.Transactions> infrastructure administrates a transaction inside a single application domain that involves at most a single durable resource or multiple volatile resources.</span></span> <span data-ttu-id="9bbf5-108">由于 <xref:System.Transactions> 基础结构仅使用应用程序内的域调用，因此会获得最佳吞吐量和性能。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-108">Since the <xref:System.Transactions> infrastructure uses only intra-application domain calls, it yields the best throughput and performance.</span></span>

<span data-ttu-id="9bbf5-109">但如果将事务提供给其他应用程序域（包括跨进程和计算机边界的应用程序域）中的其他对象，或者要登记其他持久资源管理器，则 <xref:System.Transactions> 基础结构会自动将事务升级为由 MSDTC 进行管理。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-109">However, if the transaction is provided to another object in another application domain (including across process and machine boundaries) on the same computer, or if you were to enlist another durable resource manager, the <xref:System.Transactions> infrastructure automatically escalates the transaction to be managed by the MSDTC.</span></span> <span data-ttu-id="9bbf5-110">由 MSDTC 管理的事务不像由 <xref:System.Transactions> 基础结构管理事务那样有利于性能的提高。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-110">A transaction managed by MSDTC is not as performance-wise as one managed by the <xref:System.Transactions> infrastructure.</span></span>

<span data-ttu-id="9bbf5-111">为了优化性能，<xref:System.Transactions> 基础结构提供了可提升的单阶段登记 (PSPE)；使用该功能，无需将位于不同应用程序域、进程或计算机中的单个远程持久资源升级为 MSDTC 事务，就可使其参与 <xref:System.Transactions>。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-111">To optimize performance, the <xref:System.Transactions> infrastructure provides the Promotable Single Phase Enlistment (PSPE) that allows a single remote durable resource, located in a different application domain, process or machine, to participate in a <xref:System.Transactions> transaction without causing it to be escalated to an MSDTC transaction.</span></span> <span data-ttu-id="9bbf5-112">此资源管理器 (RM) 可承载和“拥有”以后可在需要时升级为分布式事务（即 MSDTC 事务）的事务。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-112">This resource manager (RM) can host and "own" a transaction that can later be escalated to a distributed transaction (or MSDTC transaction) if necessary.</span></span> <span data-ttu-id="9bbf5-113">这减少了使用 MSDTC 的机会。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-113">This reduces the chance of using the MSDTC.</span></span>

<span data-ttu-id="9bbf5-114">此特定的资源管理器通常具有自己的内部非分布式事务，并且需要支持在运行时将这些事务转换为分布式事务。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-114">This specific resource manager usually has its own internal non distributed transactions and it needs to support converting those transactions to distributed transactions at runtime.</span></span> <span data-ttu-id="9bbf5-115">例如，SQL Server 2005 就是这样的资源管理器。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-115">For example, SQL Server 2005 is such a resource manager.</span></span> <span data-ttu-id="9bbf5-116">在这种情况下，<xref:System.Transactions> 基础结构只需监视事务是否需要升级就可发挥积极的管理作用。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-116">In such case, the <xref:System.Transactions> infrastructure takes a passive management role by just monitoring the transaction for a need for escalation.</span></span> <span data-ttu-id="9bbf5-117">若要支持 <xref:System.Transactions> 基础结构与资源管理器之间的交互，后者需要实现 <xref:System.Transactions.IPromotableSinglePhaseNotification> 接口。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-117">To support the interaction between the <xref:System.Transactions> infrastructure and resource manager, the latter needs to implement the interface <xref:System.Transactions.IPromotableSinglePhaseNotification>.</span></span>

<span data-ttu-id="9bbf5-118"><xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> 方法用于登记以后可升级的单个持久资源。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-118">The <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> method is used to enlist a single durable resource that can be escalated later.</span></span> <span data-ttu-id="9bbf5-119">此方法确保了可根据需要升级登记。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-119">This method ensures that the enlistment can be escalated as needed.</span></span> <span data-ttu-id="9bbf5-120">如果该登记成功，则 RM 会创建其内部事务，并将该事务与 <xref:System.Transactions> 事务关联。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-120">If the enlistment succeeds, the RM creates its internal transaction and associates it with the <xref:System.Transactions> transaction.</span></span> <span data-ttu-id="9bbf5-121">如果 PSPE 登记失败，则 RM 应改用 <xref:System.Transactions.Transaction.EnlistDurable%2A> 方法进行登记。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-121">If the PSPE enlistment fails, the RM should instead enlist using the <xref:System.Transactions.Transaction.EnlistDurable%2A> method.</span></span> <span data-ttu-id="9bbf5-122">当事务已是分布式事务或者其他 PSPE 已执行 PSPE 登记时，可能就无法用 PSPE 登记。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-122">Failures to enlist in PSPE might happen when the transaction is already a distributed transaction, or when another RM has already performed a PSPE enlistment</span></span>

<span data-ttu-id="9bbf5-123">登记后，分别通过调用 <xref:System.Transactions> 或 <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> 方法，将客户端用于提交或中止 <xref:System.Transactions.IPromotableSinglePhaseNotification.Rollback%2A> 事务的调用转换为对资源管理器的调用。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-123">Once enlisted, calls by clients to commit or abort the <xref:System.Transactions> transaction are converted to calls on the Resource Manager by invoking the <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> method, or the <xref:System.Transactions.IPromotableSinglePhaseNotification.Rollback%2A> respectively.</span></span>

<span data-ttu-id="9bbf5-124">如果 <xref:System.Transactions> 事务从不需要升级，则在提交该事务时，RM 会接收到 <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> 通知。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-124">If the <xref:System.Transactions> transaction never requires escalation, when the transaction is committed, the RM receives a <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> notification.</span></span> <span data-ttu-id="9bbf5-125">这样，就可以提交最初创建的内部事务。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-125">It can then commit the internal transaction that was initially created.</span></span>

<span data-ttu-id="9bbf5-126">如果需要升级 <xref:System.Transactions> 事务（例如，要支持多个 RM），则 <xref:System.Transactions> 会通过在 <xref:System.Transactions.ITransactionPromoter.Promote%2A> 接口（从其派生 <xref:System.Transactions.ITransactionPromoter> 接口）上调用 <xref:System.Transactions.IPromotableSinglePhaseNotification> 方法，向资源管理器发出通知。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-126">If the <xref:System.Transactions> transaction needs to be escalated (e.g., to support multiple RMs), <xref:System.Transactions> informs the resource manager by calling the <xref:System.Transactions.ITransactionPromoter.Promote%2A> method on the <xref:System.Transactions.ITransactionPromoter> interface, from which the <xref:System.Transactions.IPromotableSinglePhaseNotification> interface derives.</span></span> <span data-ttu-id="9bbf5-127">然后，资源管理器在内部将该事务从本地事务（不要求进行日志记录）转换为能够参与 DTC 事务的事务对象，并将其与已执行的工作关联。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-127">The resource manager then converts the transaction internally from a local transaction (which does not require logging) to a transaction object that is capable of participating in a DTC transaction, and associates it with the work already done.</span></span> <span data-ttu-id="9bbf5-128">在请求提交该事务时，事务管理器仍会将 <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> 通知发送给资源管理器，而后者会提交在升级期间创建的分布式事务。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-128">When the transaction is asked to commit, the transaction manager still sends the <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> notification to the resource manager, which commits the distributed transaction that it created during escalation.</span></span>

> [!NOTE]
> <span data-ttu-id="9bbf5-129">**TransactionCommitted**跟踪（在升级的事务上调用 Commit 时生成）包含 DTC 事务的活动 ID。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-129">The **TransactionCommitted** traces (that are generated when a Commit is invoked on the escalated transaction) contain the activity ID of the DTC transaction.</span></span>

<span data-ttu-id="9bbf5-130">有关管理升级的详细信息，请参阅[事务管理升级](transaction-management-escalation.md)。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-130">For more information on management escalation, see [Transaction Management Escalation](transaction-management-escalation.md).</span></span>

## <a name="transaction-management-escalation-scenario"></a><span data-ttu-id="9bbf5-131">事务管理升级方案</span><span class="sxs-lookup"><span data-stu-id="9bbf5-131">Transaction Management Escalation Scenario</span></span>

<span data-ttu-id="9bbf5-132">下面的方案演示如何将一个事务升级为分布式事务，该方案将 <xref:System.Data> 命名空间用作资源管理器的“代理”。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-132">The following scenario demonstrates an escalation to a distributed transaction using the <xref:System.Data> namespace as the ‘proxy’ for the resource manager.</span></span> <span data-ttu-id="9bbf5-133">该方案假定该事务中已包含一个至数据库的 <xref:System.Data> 连接 CN1，并且应用程序希望包含另一个 <xref:System.Data> 连接 CN2。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-133">This scenario assumes that there is already one <xref:System.Data> connection to the database, CN1, involved in the transaction, and the application wants to involve another <xref:System.Data> connection, CN2.</span></span> <span data-ttu-id="9bbf5-134">该事务必须作为完全分布式的两阶段提交事务升级到 DTC。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-134">The transaction must be escalated to DTC, as a full distributed two-phase commit transaction.</span></span>

<span data-ttu-id="9bbf5-135">在此方案中</span><span class="sxs-lookup"><span data-stu-id="9bbf5-135">In this scenario,</span></span>

1. <span data-ttu-id="9bbf5-136">CN1 调用 <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> 方法以在该事务中登记。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-136">CN1 calls the <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> method to enlist in the transaction.</span></span> <span data-ttu-id="9bbf5-137">这样，该事务仍是本地事务，并且该事务上没有其他可提升的登记，因此 <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> 调用会成功执行。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-137">Then, the transaction is still local and there are no other promotable enlistments on the transaction, so the <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> call succeeds.</span></span>

2. <span data-ttu-id="9bbf5-138">当第二个连接 CN2 调用 <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> 时，该调用会因包含另一个可提升的登记而失败。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-138">When the second connection, CN2 calls <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A>, the call fails because there is another promotable enlistment involved.</span></span> <span data-ttu-id="9bbf5-139">因此，CN2 必须获取 DTC 事务才能将它传递给 SQL。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-139">Because of this, CN2 must get a DTC transaction in order to pass it to SQL.</span></span> <span data-ttu-id="9bbf5-140">若要实现此目的，CN2 将使用 <xref:System.Transactions.TransactionInterop> 类所提供的方法之一生成一种可提供给 SQL 的事务格式。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-140">To do this, it uses one of the methods provided by the <xref:System.Transactions.TransactionInterop> class to produce a format of the transaction that can be given to SQL.</span></span>

3. <span data-ttu-id="9bbf5-141"><xref:System.Transactions> 在由 CN1 实现的 <xref:System.Transactions.ITransactionPromoter.Promote%2A> 接口上调用 <xref:System.Transactions.ITransactionPromoter> 方法。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-141"><xref:System.Transactions> calls the <xref:System.Transactions.ITransactionPromoter.Promote%2A> method on the <xref:System.Transactions.ITransactionPromoter> interface implemented by CN1.</span></span>

4. <span data-ttu-id="9bbf5-142">此时，CN1 使用 SQL 2005 和 <xref:System.Data> 特定的某一机制升级该事务。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-142">At this point, CN1 escalates the transaction, using some mechanism specific to SQL 2005 and <xref:System.Data>.</span></span>

5. <span data-ttu-id="9bbf5-143"><xref:System.Transactions.ITransactionPromoter.Promote%2A> 方法中的返回值是一个包含事务的传播标记的字节数组。 </span><span class="sxs-lookup"><span data-stu-id="9bbf5-143">The return value from the <xref:System.Transactions.ITransactionPromoter.Promote%2A> method is a byte array that contains a propagation token for the transaction.</span></span> <span data-ttu-id="9bbf5-144"><xref:System.Transactions>使用此传播令牌创建可合并到本地事务中的 DTC 事务。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-144"><xref:System.Transactions> uses this propagation token to create a DTC transaction that it can incorporate into the local transaction.</span></span>

6. <span data-ttu-id="9bbf5-145">此时，CN2 可使用通过调用 <xref:System.Transactions.TransactionInterop> 方法之一而接收到的数据，来将事务传入 SQL 中。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-145">At this point, CN2 can use the data received from calling one of the methods by <xref:System.Transactions.TransactionInterop> to pass the transaction to SQL.</span></span>

7. <span data-ttu-id="9bbf5-146">现在，这两个连接都登记到了 DTC 分布式事务中。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-146">Now, both are enlisted in a DTC distributed transaction.</span></span>

## <a name="single-phase-commit-optimization"></a><span data-ttu-id="9bbf5-147">单阶段提交优化</span><span class="sxs-lookup"><span data-stu-id="9bbf5-147">Single Phase Commit Optimization</span></span>

<span data-ttu-id="9bbf5-148">单阶段提交协议在运行时更有效，因为使用它时，无需进行任何显式协调即可执行所有更新。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-148">The Single Phase Commit protocol is more efficient at runtime as all updates are done without any explicit coordination.</span></span> <span data-ttu-id="9bbf5-149">若要利用此优化，应对资源使用 <xref:System.Transactions.ISinglePhaseNotification> 接口来实现资源管理器，并使用 <xref:System.Transactions.Transaction.EnlistDurable%2A> 或 <xref:System.Transactions.Transaction.EnlistVolatile%2A> 方法在事务中登记。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-149">To take advantage of this optimization, you should implement a resource manager using <xref:System.Transactions.ISinglePhaseNotification> interface for the resource and enlist in a transaction using the <xref:System.Transactions.Transaction.EnlistDurable%2A> or <xref:System.Transactions.Transaction.EnlistVolatile%2A> method.</span></span> <span data-ttu-id="9bbf5-150">具体而言， *EnlistmentOptions*参数应该等于， <xref:System.Transactions.EnlistmentOptions.None> 以确保执行单阶段提交。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-150">Specifically, the *EnlistmentOptions* parameter should equal to <xref:System.Transactions.EnlistmentOptions.None> to ensure that a single phase commit would be performed.</span></span>

<span data-ttu-id="9bbf5-151">由于 <xref:System.Transactions.ISinglePhaseNotification> 接口是从 <xref:System.Transactions.IEnlistmentNotification> 接口派生的，因此如果 RM 不适合执行单阶段提交，它仍可接收两阶段提交通知。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-151">Since the <xref:System.Transactions.ISinglePhaseNotification> interface derives from the <xref:System.Transactions.IEnlistmentNotification> interface, if your RM is not eligible for single phase commit, it can still receive the two phase commit notifications.</span></span> <span data-ttu-id="9bbf5-152">如果 RM 从 TM 接收到 <xref:System.Transactions.ISinglePhaseNotification.SinglePhaseCommit%2A> 通知，它应尝试完成提交所需的工作，并在 <xref:System.Transactions.SinglePhaseEnlistment.Committed%2A> 参数上调用 <xref:System.Transactions.SinglePhaseEnlistment.Aborted%2A>、<xref:System.Transactions.SinglePhaseEnlistment.InDoubt%2A> 或 <xref:System.Transactions.SinglePhaseEnlistment> 方法，来相应地通知事务管理器是提交还是回滚事务。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-152">If your RM receives a <xref:System.Transactions.ISinglePhaseNotification.SinglePhaseCommit%2A> notification from the TM, it should try to do the work necessary for it to commit and correspondingly inform the transaction manager if the transaction is to be committed or rolled back by calling the <xref:System.Transactions.SinglePhaseEnlistment.Committed%2A>, <xref:System.Transactions.SinglePhaseEnlistment.Aborted%2A>, or <xref:System.Transactions.SinglePhaseEnlistment.InDoubt%2A> method on the <xref:System.Transactions.SinglePhaseEnlistment> parameter.</span></span> <span data-ttu-id="9bbf5-153">在此阶段中，登记时的 <xref:System.Transactions.Enlistment.Done%2A> 响应表示 ReadOnly 语义。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-153">A response of <xref:System.Transactions.Enlistment.Done%2A> on the enlistment at this stage implies ReadOnly semantics.</span></span> <span data-ttu-id="9bbf5-154">因此，不应答复 <xref:System.Transactions.Enlistment.Done%2A> 以及任何其他方法。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-154">Therefore, you should not reply <xref:System.Transactions.Enlistment.Done%2A> in addition to any of the other methods.</span></span>

<span data-ttu-id="9bbf5-155">如果只有一个可变登记并且没有持久登记，则可变登记会收到 SPC 通知。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-155">If there is only one volatile enlistment and no durable enlistment, the volatile enlistment receives SPC notification.</span></span> <span data-ttu-id="9bbf5-156">如果存在任何易失性登记并且只有一个持久登记，则可变登记会接收2PC。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-156">If there are any volatile enlistments and only one durable enlistment, the volatile enlistments receive 2PC.</span></span> <span data-ttu-id="9bbf5-157">完成提交后，持久登记会接收到 SPC 通知。</span><span class="sxs-lookup"><span data-stu-id="9bbf5-157">When it is completed, the durable enlistment receives SPC.</span></span>

## <a name="see-also"></a><span data-ttu-id="9bbf5-158">另请参阅</span><span class="sxs-lookup"><span data-stu-id="9bbf5-158">See also</span></span>

- [<span data-ttu-id="9bbf5-159">在事务中将资源登记为参与者</span><span class="sxs-lookup"><span data-stu-id="9bbf5-159">Enlisting Resources as Participants in a Transaction</span></span>](enlisting-resources-as-participants-in-a-transaction.md)
- [<span data-ttu-id="9bbf5-160">在单阶段和多阶段中提交事务</span><span class="sxs-lookup"><span data-stu-id="9bbf5-160">Committing a Transaction in Single-Phase and Multi-Phase</span></span>](committing-a-transaction-in-single-phase-and-multi-phase.md)
