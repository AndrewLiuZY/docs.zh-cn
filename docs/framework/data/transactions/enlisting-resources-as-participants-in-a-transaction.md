---
title: 在事务中将资源登记为参与者
description: 在 .NET 事务中将资源登记为参与者。 事务中的每个资源都由资源管理器进行管理，由事务管理器进行协调。
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 786a12c2-d530-49f4-9c59-5c973e15a11d
ms.openlocfilehash: c3c777593750b3a4f05ae97ed6e26e19f58e4d72
ms.sourcegitcommit: 6219b1e1feccb16d88656444210fed3297f5611e
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 06/22/2020
ms.locfileid: "85141870"
---
# <a name="enlisting-resources-as-participants-in-a-transaction"></a><span data-ttu-id="f32ad-104">在事务中将资源登记为参与者</span><span class="sxs-lookup"><span data-stu-id="f32ad-104">Enlisting Resources as Participants in a Transaction</span></span>

<span data-ttu-id="f32ad-105">参与事务的每个资源都由资源管理器进行管理，而后者的操作则由事务管理器进行协调。</span><span class="sxs-lookup"><span data-stu-id="f32ad-105">Each resource participating in a transaction is managed by a resource manager, whose actions are coordinated by a transaction manager.</span></span> <span data-ttu-id="f32ad-106">这一协调通过通知来执行，这些通知会提供给已通过事务管理器在事务中登记的订户。</span><span class="sxs-lookup"><span data-stu-id="f32ad-106">The coordination is done through notifications given to subscribers who have enlisted in a transaction through the transaction manager.</span></span>

<span data-ttu-id="f32ad-107">本主题介绍如何在事务中登记一个资源（或多个资源）以及不同的登记类型。</span><span class="sxs-lookup"><span data-stu-id="f32ad-107">This topic covers how a resource (or multiple resources) can be enlisted in a transaction, as well as the different types of enlistment.</span></span> <span data-ttu-id="f32ad-108">[在单阶段和多阶段中提交事务](committing-a-transaction-in-single-phase-and-multi-phase.md)主题介绍了如何在已登记的资源之间协调事务提交。</span><span class="sxs-lookup"><span data-stu-id="f32ad-108">The [Committing a Transaction in Single-Phase and Multi-Phase](committing-a-transaction-in-single-phase-and-multi-phase.md) topic covers how transaction commitment can be coordinated among enlisted resources.</span></span>

## <a name="enlisting-resources-in-a-transaction"></a><span data-ttu-id="f32ad-109">在事务中登记资源</span><span class="sxs-lookup"><span data-stu-id="f32ad-109">Enlisting Resources in a Transaction</span></span>

<span data-ttu-id="f32ad-110">资源若要参与事务，它必须在事务中进行登记。</span><span class="sxs-lookup"><span data-stu-id="f32ad-110">In order for a resource to participate in a transaction, it must enlist in the transaction.</span></span> <span data-ttu-id="f32ad-111"><xref:System.Transactions.Transaction>类定义一组方法，这些方法的名称以提供此功能的**征用**开头。</span><span class="sxs-lookup"><span data-stu-id="f32ad-111">The <xref:System.Transactions.Transaction> class defines a set of methods whose names begin with **Enlist** that provide this functionality.</span></span> <span data-ttu-id="f32ad-112">不同的**登记**方法对应于资源管理器可能具有的不同类型的登记。</span><span class="sxs-lookup"><span data-stu-id="f32ad-112">The different **Enlist** methods correspond to the different types of enlistment that a resource manager may have.</span></span> <span data-ttu-id="f32ad-113">具体来说，<xref:System.Transactions.Transaction.EnlistVolatile%2A> 方法用于登记可变资源，而 <xref:System.Transactions.Transaction.EnlistDurable%2A> 方法则用于登记持久资源。</span><span class="sxs-lookup"><span data-stu-id="f32ad-113">Specifically, you use the <xref:System.Transactions.Transaction.EnlistVolatile%2A> methods for volatile resources, and the <xref:System.Transactions.Transaction.EnlistDurable%2A> method for durable resources.</span></span> <span data-ttu-id="f32ad-114">资源管理器的持久性（反之为可变性）是指资源管理器是否支持故障恢复。</span><span class="sxs-lookup"><span data-stu-id="f32ad-114">The durability (or conversely the volatility) of a resource manager refers to whether the resource manager supports failure recovery.</span></span> <span data-ttu-id="f32ad-115">如果资源管理器支持故障恢复，则它会在第 1 阶段（准备阶段）将数据保存到持久存储区中；这样，一旦资源管理器出现故障，它就可在恢复时在事务中重新登记，并根据从 TM 接收到的通知执行适当的操作。</span><span class="sxs-lookup"><span data-stu-id="f32ad-115">If a resource manager supports failure recovery, it persists data to durable storage during Phase1 (prepare) such that if the resource manager goes down, it can re-enlist in the transaction upon recovery and perform the proper actions based on the notifications received from the TM.</span></span> <span data-ttu-id="f32ad-116">通常，可变资源管理器管理如内存中的数据结构之类的可变资源（如内存中的事务处理哈希表），而持久资源管理器则管理具有更持久的后备存储区的资源（例如，其后备存储区为磁盘的数据库）。</span><span class="sxs-lookup"><span data-stu-id="f32ad-116">In general, volatile resource managers manage volatile resources such as an in-memory data structure (for example, an in-memory transacted-hashtable), and durable resource managers manage resources that have a more persistent backing store (for example, a database whose backing store is disk).</span></span>

<span data-ttu-id="f32ad-117">为了简单起见，在根据资源的持久性支持决定是使用 <xref:System.Transactions.Transaction.EnlistDurable%2A> 还是 <xref:System.Transactions.Transaction.EnlistVolatile%2A> 方法后，应为资源管理器实现 <xref:System.Transactions.IEnlistmentNotification> 接口，从而将资源登记为参与两阶段提交 (2PC)。</span><span class="sxs-lookup"><span data-stu-id="f32ad-117">For simplicity, after deciding whether to use the <xref:System.Transactions.Transaction.EnlistDurable%2A> or <xref:System.Transactions.Transaction.EnlistVolatile%2A> method based on your resource's durability support, you should enlist your resource to participate in Two Phase Commit (2PC) by implementing the <xref:System.Transactions.IEnlistmentNotification> interface for your resource manager.</span></span> <span data-ttu-id="f32ad-118">有关2PC 的详细信息，请参阅[在单阶段和多阶段提交事务](committing-a-transaction-in-single-phase-and-multi-phase.md)。</span><span class="sxs-lookup"><span data-stu-id="f32ad-118">For more information on 2PC, see [Committing a Transaction in Single-Phase and Multi-Phase](committing-a-transaction-in-single-phase-and-multi-phase.md).</span></span>

<span data-ttu-id="f32ad-119">单个参与者可以多次调用 <xref:System.Transactions.Transaction.EnlistDurable%2A> 和 <xref:System.Transactions.Transaction.EnlistVolatile%2A> 来登记到其中的某一协议。</span><span class="sxs-lookup"><span data-stu-id="f32ad-119">A single participant can enlist for more than one of these protocols by calling <xref:System.Transactions.Transaction.EnlistDurable%2A> and <xref:System.Transactions.Transaction.EnlistVolatile%2A> multiple times.</span></span>

### <a name="durable-enlistment"></a><span data-ttu-id="f32ad-120">持久登记</span><span class="sxs-lookup"><span data-stu-id="f32ad-120">Durable Enlistment</span></span>

<span data-ttu-id="f32ad-121"><xref:System.Transactions.Transaction.EnlistDurable%2A> 方法用于登记要作为持久资源参与事务的资源管理器。</span><span class="sxs-lookup"><span data-stu-id="f32ad-121">The <xref:System.Transactions.Transaction.EnlistDurable%2A> methods are used to enlist a resource manager for participation in the transaction as a durable resource.</span></span>  <span data-ttu-id="f32ad-122">如果持久资源管理器在事务执行期间关闭，则它在重新联机后，应在它作为参与者且未完成第 2 阶段的所有事务中重新登记（使用 <xref:System.Transactions.TransactionManager.Reenlist%2A> 方法）来执行恢复，并在完成恢复处理后调用 <xref:System.Transactions.TransactionManager.RecoveryComplete%2A>。</span><span class="sxs-lookup"><span data-stu-id="f32ad-122">It is expected that if a durable resource manager is brought down in the middle of a transaction, it can perform recovery once it is brought back online by reenlisting (using the <xref:System.Transactions.TransactionManager.Reenlist%2A> method) in all transactions in which it was a participant and did not complete phase 2, and call <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> once it finishes recovery processing.</span></span> <span data-ttu-id="f32ad-123">有关恢复的详细信息，请参阅[执行恢复](performing-recovery.md)。</span><span class="sxs-lookup"><span data-stu-id="f32ad-123">For more information on recovery, see [Performing Recovery](performing-recovery.md).</span></span>

<span data-ttu-id="f32ad-124"><xref:System.Transactions.Transaction.EnlistDurable%2A> 方法都采用 <xref:System.Guid> 对象作为其第一个参数。</span><span class="sxs-lookup"><span data-stu-id="f32ad-124">The <xref:System.Transactions.Transaction.EnlistDurable%2A> methods all take a <xref:System.Guid> object as their first parameter.</span></span> <span data-ttu-id="f32ad-125">事务管理器使用 <xref:System.Guid> 将持久登记与特定的资源管理器关联。</span><span class="sxs-lookup"><span data-stu-id="f32ad-125">The <xref:System.Guid> is used by the transaction manager to associate a durable enlistment with a particular resource manager.</span></span> <span data-ttu-id="f32ad-126">因此，资源管理器在重新启动后必须统一使用同一 <xref:System.Guid> 来标识自身，即使跨不同的资源管理器时也是如此；否则恢复操作就可能失败。</span><span class="sxs-lookup"><span data-stu-id="f32ad-126">As such, it is imperative that a resource manager consistently uses the same <xref:System.Guid> to identify itself even across different resource managers upon restarting, otherwise the recovery can fail.</span></span>

<span data-ttu-id="f32ad-127"><xref:System.Transactions.Transaction.EnlistDurable%2A> 方法的第二个参数是对资源管理器所实现的用于接收事务通知的对象的引用。</span><span class="sxs-lookup"><span data-stu-id="f32ad-127">The second parameter of the <xref:System.Transactions.Transaction.EnlistDurable%2A> method is a reference to the object that the resource manager implements to receive transaction notifications.</span></span> <span data-ttu-id="f32ad-128">您所使用的重载会向事务管理器通知资源管理器是否支持单阶段提交 (SPC) 优化。</span><span class="sxs-lookup"><span data-stu-id="f32ad-128">The overload you use informs the transaction manager whether your resource manager supports the Single Phase Commit (SPC) optimization.</span></span> <span data-ttu-id="f32ad-129">大多数情况下，应实现 <xref:System.Transactions.IEnlistmentNotification> 接口来参与两阶段提交 (2PC)。</span><span class="sxs-lookup"><span data-stu-id="f32ad-129">Most of the time you would implement the <xref:System.Transactions.IEnlistmentNotification> interface to take part in Two-Phase Commit (2PC).</span></span> <span data-ttu-id="f32ad-130">但如果要优化提交过程，可考虑实现 <xref:System.Transactions.ISinglePhaseNotification> 接口来参与 SPC。</span><span class="sxs-lookup"><span data-stu-id="f32ad-130">However, if you want to optimize the commit process, you can consider implementing the <xref:System.Transactions.ISinglePhaseNotification> interface for SPC.</span></span> <span data-ttu-id="f32ad-131">有关 SPC 的详细信息，请参阅[使用单阶段提交和可提升的单阶段通知](optimization-spc-and-promotable-spn.md)[在单阶段和多阶段和优化中提交事务](committing-a-transaction-in-single-phase-and-multi-phase.md)。</span><span class="sxs-lookup"><span data-stu-id="f32ad-131">For more information on SPC, see [Committing a Transaction in Single-Phase and Multi-Phase](committing-a-transaction-in-single-phase-and-multi-phase.md) and [Optimization using Single Phase Commit and Promotable Single Phase Notification](optimization-spc-and-promotable-spn.md).</span></span>

<span data-ttu-id="f32ad-132">第三个参数是 <xref:System.Transactions.EnlistmentOptions> 枚举，该枚举的值可以为 <xref:System.Transactions.EnlistmentOptions.None> 或 <xref:System.Transactions.EnlistmentOptions.EnlistDuringPrepareRequired>。</span><span class="sxs-lookup"><span data-stu-id="f32ad-132">The third parameter is an <xref:System.Transactions.EnlistmentOptions> enumeration, whose value can be either <xref:System.Transactions.EnlistmentOptions.None> or <xref:System.Transactions.EnlistmentOptions.EnlistDuringPrepareRequired>.</span></span> <span data-ttu-id="f32ad-133">如果将该值设置为 <xref:System.Transactions.EnlistmentOptions.EnlistDuringPrepareRequired>，则这种登记类型可在从事务管理器接收到准备通知时登记附加资源管理器。</span><span class="sxs-lookup"><span data-stu-id="f32ad-133">If the value is set to <xref:System.Transactions.EnlistmentOptions.EnlistDuringPrepareRequired>, the enlistment may enlist additional resource managers upon receiving the Prepare notification from the transaction manager.</span></span> <span data-ttu-id="f32ad-134">但是，您应清楚这种登记类型不适合执行单阶段提交优化。</span><span class="sxs-lookup"><span data-stu-id="f32ad-134">However, you should be aware that this type of enlistment is not eligible for the Single Phase Commit optimization.</span></span>

### <a name="volatile-enlistment"></a><span data-ttu-id="f32ad-135">可变登记</span><span class="sxs-lookup"><span data-stu-id="f32ad-135">Volatile Enlistment</span></span>

<span data-ttu-id="f32ad-136">管理可变资源（如缓存）的参与者应使用 <xref:System.Transactions.Transaction.EnlistVolatile%2A> 方法进行登记。</span><span class="sxs-lookup"><span data-stu-id="f32ad-136">Participants managing volatile resources such as a cache should enlist using the <xref:System.Transactions.Transaction.EnlistVolatile%2A> methods.</span></span> <span data-ttu-id="f32ad-137">此类对象可能无法获取事务的结果，或者在系统出现故障后可能无法恢复它们所参与的任何事务的状态。</span><span class="sxs-lookup"><span data-stu-id="f32ad-137">Such objects might not be able to obtain the outcome of a transaction or recover the state of any transaction they participate in after a system failure.</span></span>

<span data-ttu-id="f32ad-138">如前面所述，资源管理器在管理内存中的可变资源时应进行可变登记。</span><span class="sxs-lookup"><span data-stu-id="f32ad-138">As stated previously, a resource manager would make a volatile enlistment if it manages an in-memory, volatile resource.</span></span> <span data-ttu-id="f32ad-139">使用 <xref:System.Transactions.Transaction.EnlistVolatile%2A> 的优点之一就是不会强制执行不必要的事务升级。</span><span class="sxs-lookup"><span data-stu-id="f32ad-139">One of the benefits of using <xref:System.Transactions.Transaction.EnlistVolatile%2A> is that it does not force an unnecessary escalation of the transaction.</span></span> <span data-ttu-id="f32ad-140">有关事务升级的详细信息，请参阅[事务管理升级](transaction-management-escalation.md)主题。</span><span class="sxs-lookup"><span data-stu-id="f32ad-140">For more information on transaction escalation, see [Transaction Management Escalation](transaction-management-escalation.md) topic.</span></span> <span data-ttu-id="f32ad-141">登记波动性意味着事务管理器处理登记的方式和事务管理器预期的资源管理器的预期差别。</span><span class="sxs-lookup"><span data-stu-id="f32ad-141">Enlisting volatility implies both a difference in how the enlistment is handled by the transaction manager, as well as what is expected of the resource manager by the transaction manager.</span></span> <span data-ttu-id="f32ad-142">这是因为可变资源管理器不执行恢复。</span><span class="sxs-lookup"><span data-stu-id="f32ad-142">This is because a volatile resource manager does not perform recovery.</span></span> <span data-ttu-id="f32ad-143"><xref:System.Transactions.Transaction.EnlistVolatile%2A> 方法不采用 <xref:System.Guid> 参数，因为可变资源管理器不执行恢复，并且不会调用需要 <xref:System.Transactions.TransactionManager.Reenlist%2A> 的 <xref:System.Guid> 方法。</span><span class="sxs-lookup"><span data-stu-id="f32ad-143">The <xref:System.Transactions.Transaction.EnlistVolatile%2A> methods do not take a <xref:System.Guid> parameter, because a volatile resource manager does not perform recovery and would not call the <xref:System.Transactions.TransactionManager.Reenlist%2A> method which needs a <xref:System.Guid>.</span></span>

<span data-ttu-id="f32ad-144">与持久登记一样，无论使用哪种重载方法进行登记，都会向事务管理器指示资源管理器是否支持单阶段提交优化。</span><span class="sxs-lookup"><span data-stu-id="f32ad-144">As with durable enlistments, whichever overload method you use to enlist denotes to the transaction manager whether your resource manager supports the Single Phase Commit optimization.</span></span> <span data-ttu-id="f32ad-145">由于可变资源管理器不能执行恢复，因此在准备阶段不会为可变登记写入任何恢复信息。</span><span class="sxs-lookup"><span data-stu-id="f32ad-145">Since a volatile resource manager cannot perform recovery, no recovery information is written for a volatile enlistment during the Prepare phase.</span></span> <span data-ttu-id="f32ad-146">因此，调用 <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> 方法会导致 <xref:System.InvalidOperationException>。</span><span class="sxs-lookup"><span data-stu-id="f32ad-146">Therefore, calling the <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> method results in an <xref:System.InvalidOperationException>.</span></span>

<span data-ttu-id="f32ad-147">下面的示例演示如何使用 <xref:System.Transactions.Transaction.EnlistVolatile%2A> 方法在事务中将此类对象登记为参与者。</span><span class="sxs-lookup"><span data-stu-id="f32ad-147">The following example shows how to enlist such an object as a participant in a transaction using the <xref:System.Transactions.Transaction.EnlistVolatile%2A> method.</span></span>

[!code-csharp[Tx_Enlist#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/tx_enlist/cs/enlist.cs#1)]
[!code-vb[Tx_Enlist#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/tx_enlist/vb/enlist.vb#1)]

### <a name="optimizing-performance"></a><span data-ttu-id="f32ad-148">优化性能</span><span class="sxs-lookup"><span data-stu-id="f32ad-148">Optimizing Performance</span></span>

<span data-ttu-id="f32ad-149"><xref:System.Transactions.Transaction> 类还提供了 <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> 方法来登记可提升的单阶段登记 (PSPE)。</span><span class="sxs-lookup"><span data-stu-id="f32ad-149">The <xref:System.Transactions.Transaction> class also provides the <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> method to enlist a Promotable Single Phase Enlistment (PSPE).</span></span> <span data-ttu-id="f32ad-150">这使持久资源管理器 (RM) 可承载和“拥有”以后可在需要时升级为由 MSDTC 进行管理的事务。</span><span class="sxs-lookup"><span data-stu-id="f32ad-150">This allows a durable resource manager (RM) to host and "own" a transaction that can later be escalated to be managed by the MSDTC if necessary.</span></span> <span data-ttu-id="f32ad-151">有关此内容的详细信息，请参阅[使用单阶段提交和可提升的单阶段通知进行优化](optimization-spc-and-promotable-spn.md)。</span><span class="sxs-lookup"><span data-stu-id="f32ad-151">For more information on this, see [Optimization using Single Phase Commit and Promotable Single Phase Notification](optimization-spc-and-promotable-spn.md).</span></span>

## <a name="see-also"></a><span data-ttu-id="f32ad-152">另请参阅</span><span class="sxs-lookup"><span data-stu-id="f32ad-152">See also</span></span>

- [<span data-ttu-id="f32ad-153">使用单阶段提交和可提升的单阶段通知进行优化</span><span class="sxs-lookup"><span data-stu-id="f32ad-153">Optimization using Single Phase Commit and Promotable Single Phase Notification</span></span>](optimization-spc-and-promotable-spn.md)
- [<span data-ttu-id="f32ad-154">在单阶段和多阶段中提交事务</span><span class="sxs-lookup"><span data-stu-id="f32ad-154">Committing a Transaction in Single-Phase and Multi-Phase</span></span>](committing-a-transaction-in-single-phase-and-multi-phase.md)
