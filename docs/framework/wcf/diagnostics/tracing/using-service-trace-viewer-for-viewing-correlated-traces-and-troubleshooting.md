---
title: 使用服务跟踪查看器查看相关跟踪和进行故障诊断
ms.date: 03/30/2017
ms.assetid: 05d2321c-8acb-49d7-a6cd-8ef2220c6775
ms.openlocfilehash: e1cd1443e96e7195127cb95e7ef1b2c4d6d9c176
ms.sourcegitcommit: cdb295dd1db589ce5169ac9ff096f01fd0c2da9d
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 06/09/2020
ms.locfileid: "84587750"
---
# <a name="using-service-trace-viewer-for-viewing-correlated-traces-and-troubleshooting"></a><span data-ttu-id="ea881-102">使用服务跟踪查看器查看相关跟踪和进行故障诊断</span><span class="sxs-lookup"><span data-stu-id="ea881-102">Using Service Trace Viewer for Viewing Correlated Traces and Troubleshooting</span></span>

<span data-ttu-id="ea881-103">本主题介绍跟踪数据的格式，如何查看它，以及使用服务跟踪查看器对应用程序进行故障诊断的方法。</span><span class="sxs-lookup"><span data-stu-id="ea881-103">This topic describes the format of trace data, how to view it, and approaches that use the Service Trace Viewer to troubleshoot your application.</span></span>

## <a name="using-the-service-trace-viewer-tool"></a><span data-ttu-id="ea881-104">使用服务跟踪查看器工具</span><span class="sxs-lookup"><span data-stu-id="ea881-104">Using the Service Trace Viewer Tool</span></span>

<span data-ttu-id="ea881-105">Windows Communication Foundation （WCF）服务跟踪查看器工具可帮助您关联 WCF 侦听器生成的诊断跟踪，以找出错误的根本原因。</span><span class="sxs-lookup"><span data-stu-id="ea881-105">The Windows Communication Foundation (WCF) Service Trace Viewer tool helps you correlate diagnostic traces produced by WCF listeners to locate the root cause of an error.</span></span> <span data-ttu-id="ea881-106">该工具为您提供了一种轻松查看、分组和筛选跟踪的方法，以便您可以诊断、修复和验证 WCF 服务的问题。</span><span class="sxs-lookup"><span data-stu-id="ea881-106">The tool gives you a way to easily view, group, and filter traces so that you can diagnose, repair and verify issues with WCF services.</span></span> <span data-ttu-id="ea881-107">有关使用此工具的详细信息，请参阅[服务跟踪查看器工具（svctraceviewer.exe）](../../service-trace-viewer-tool-svctraceviewer-exe.md)。</span><span class="sxs-lookup"><span data-stu-id="ea881-107">For more information about using this tool, see [Service Trace Viewer Tool (SvcTraceViewer.exe)](../../service-trace-viewer-tool-svctraceviewer-exe.md).</span></span>

<span data-ttu-id="ea881-108">本主题包含在使用[服务跟踪查看器工具（svctraceviewer.exe）](../../service-trace-viewer-tool-svctraceviewer-exe.md)进行查看时，通过运行[跟踪和消息日志记录](../../samples/tracing-and-message-logging.md)示例生成的跟踪的屏幕截图。</span><span class="sxs-lookup"><span data-stu-id="ea881-108">This topic contains screenshots of traces generated by running the [Tracing and Message Logging](../../samples/tracing-and-message-logging.md) sample, when viewed using the [Service Trace Viewer Tool (SvcTraceViewer.exe)](../../service-trace-viewer-tool-svctraceviewer-exe.md).</span></span> <span data-ttu-id="ea881-109">本主题演示如何了解跟踪内容、活动及其关联，以及进行故障诊断时如何分析大量跟踪。</span><span class="sxs-lookup"><span data-stu-id="ea881-109">This topic demonstrates how to understand trace content, activities and their correlation, and how to analyze large numbers of traces when troubleshooting.</span></span>

## <a name="viewing-trace-content"></a><span data-ttu-id="ea881-110">查看跟踪内容</span><span class="sxs-lookup"><span data-stu-id="ea881-110">Viewing Trace Content</span></span>

<span data-ttu-id="ea881-111">跟踪事件包含以下最重要的信息：</span><span class="sxs-lookup"><span data-stu-id="ea881-111">A trace event contains the following most significant information:</span></span>

- <span data-ttu-id="ea881-112">设置时的活动名称。</span><span class="sxs-lookup"><span data-stu-id="ea881-112">Activity name when set.</span></span>

- <span data-ttu-id="ea881-113">发出时间。</span><span class="sxs-lookup"><span data-stu-id="ea881-113">Emission time.</span></span>

- <span data-ttu-id="ea881-114">跟踪级别。</span><span class="sxs-lookup"><span data-stu-id="ea881-114">Trace level.</span></span>

- <span data-ttu-id="ea881-115">跟踪源名称。</span><span class="sxs-lookup"><span data-stu-id="ea881-115">Trace source name.</span></span>

- <span data-ttu-id="ea881-116">进程名称。</span><span class="sxs-lookup"><span data-stu-id="ea881-116">Process name.</span></span>

- <span data-ttu-id="ea881-117">线程 ID。</span><span class="sxs-lookup"><span data-stu-id="ea881-117">Thread id.</span></span>

- <span data-ttu-id="ea881-118">唯一跟踪标识符，它是指向 Microsoft Docs 中的目标的 URL，可从中获取与跟踪相关的详细信息。</span><span class="sxs-lookup"><span data-stu-id="ea881-118">A unique trace identifier, which is a URL that points to a destination in Microsoft Docs, from which you can obtain more information related to the trace.</span></span>

 <span data-ttu-id="ea881-119">所有这些都可以在服务跟踪查看器的右上窗格中查看，也可以在选择跟踪时右下面板的 "格式视图" 视图中的 "**基本信息**" 部分中查看。</span><span class="sxs-lookup"><span data-stu-id="ea881-119">All of these can be seen in the upper right panel in the Service Trace Viewer, or in the **Basic Information** section in the formatted view of the lower-right panel when selecting a trace.</span></span>

> [!NOTE]
> <span data-ttu-id="ea881-120">如果客户端和服务位于同一计算机上，则将显示针对这两个应用程序的跟踪。</span><span class="sxs-lookup"><span data-stu-id="ea881-120">If the client and the service are on the same machine, the traces for both applications will be present.</span></span> <span data-ttu-id="ea881-121">可以使用 "**进程名称**" 列筛选这些字段。</span><span class="sxs-lookup"><span data-stu-id="ea881-121">These can be filtered using the **Process Name** column.</span></span>

<span data-ttu-id="ea881-122">此外，格式化视图还提供了跟踪说明和其他可用的详细信息。</span><span class="sxs-lookup"><span data-stu-id="ea881-122">In addition, the formatted view also provides a description for the trace and additional detailed information when available.</span></span> <span data-ttu-id="ea881-123">后者可以包括异常类型和消息、调用堆栈、消息操作、从/到字段以及其他异常信息。</span><span class="sxs-lookup"><span data-stu-id="ea881-123">The latter can include exception type and message, call stacks, message action, from/to fields, and other exception information.</span></span>

<span data-ttu-id="ea881-124">在 XML 视图中，有用的 xml 标记包括：</span><span class="sxs-lookup"><span data-stu-id="ea881-124">In the XML view, useful xml tags include the following:</span></span>

- <span data-ttu-id="ea881-125">`<SubType>`（跟踪级别）。</span><span class="sxs-lookup"><span data-stu-id="ea881-125">`<SubType>` (trace level).</span></span>

- <span data-ttu-id="ea881-126">`<TimeCreated>`.</span><span class="sxs-lookup"><span data-stu-id="ea881-126">`<TimeCreated>`.</span></span>

- <span data-ttu-id="ea881-127">`<Source>`（跟踪源名称）。</span><span class="sxs-lookup"><span data-stu-id="ea881-127">`<Source>` (trace source name).</span></span>

- <span data-ttu-id="ea881-128">`<Correlation>`（发出跟踪时设置的活动 id）。</span><span class="sxs-lookup"><span data-stu-id="ea881-128">`<Correlation>` (activity id set when emitting the trace).</span></span>

- <span data-ttu-id="ea881-129">`<Execution>`（进程和线程 id）。</span><span class="sxs-lookup"><span data-stu-id="ea881-129">`<Execution>` (process and thread id).</span></span>

- <span data-ttu-id="ea881-130">`<Computer>`.</span><span class="sxs-lookup"><span data-stu-id="ea881-130">`<Computer>`.</span></span>

- <span data-ttu-id="ea881-131">`<ExtendedData>`，包括 `<Action>` ， `<MessageID>` 以及在 `<ActivityId>` 发送消息时在消息头中设置的。</span><span class="sxs-lookup"><span data-stu-id="ea881-131">`<ExtendedData>`, including `<Action>`, `<MessageID>` and the `<ActivityId>` set in the message header when sending a message.</span></span>

<span data-ttu-id="ea881-132">如果检查“通过通道发送消息”跟踪，则可能会看到以下内容。</span><span class="sxs-lookup"><span data-stu-id="ea881-132">If you examine the "Sent a message over a channel" trace, you may see the following content.</span></span>

```xml
<E2ETraceEvent xmlns="http://schemas.microsoft.com/2004/06/E2ETraceEvent">
   <System xmlns="http://schemas.microsoft.com/2004/06/windows/eventlog/system">
      <EventID>262163</EventID>
      <Type>3</Type>
      <SubType Name="Information">0</SubType>
      <Level>8</Level>
      <TimeCreated SystemTime="2006-08-04T18:45:30.8491051Z" />
      <Source Name="System.ServiceModel" />
       <Correlation ActivityID="{27c6331d-8998-43aa-a382-03239013a6bd}"/>
       <Execution ProcessName="client" ProcessID="1808" ThreadID="1" />
       <Channel />
       <Computer>TEST1</Computer>
   </System>
   <ApplicationData>
       <TraceData>
          <DataItem>
             <TraceRecord xmlns="http://schemas.microsoft.com/2004/10/E2ETraceEvent/TraceRecord" Severity="Information">
                 <TraceIdentifier>http://msdn.microsoft.com/library/System.ServiceModel.Channels.MessageSent.aspx</TraceIdentifier>
                 <Description>Sent a message over a channel.</Description>
                 <AppDomain>client.exe</AppDomain>
                 <Source>System.ServiceModel.Channels.ClientFramingDuplexSessionChannel/35191196</Source>
                <ExtendedData xmlns="http://schemas.microsoft.com/2006/08/ServiceModel/MessageTransmitTraceRecord">

                  <MessageProperties>
                     <AllowOutputBatching>False</AllowOutputBatching>
                  </MessageProperties>
                  <MessageHeaders>
                     <Action d4p1:mustUnderstand="1" xmlns:d4p1="http://www.w3.org/2003/05/soap-envelope" xmlns="http://www.w3.org/2005/08/addressing">http://Microsoft.ServiceModel.Samples/ICalculator/Multiply</Action>
                     <MessageID xmlns="http://www.w3.org/2005/08/addressing">urn:uuid:7c6670d8-4c9c-496e-b6a0-2ceb6db35338</MessageID>
                     <ActivityId CorrelationId="b02e2189-0816-4387-980c-dd8e306440f5" xmlns="http://schemas.microsoft.com/2004/09/ServiceModel/Diagnostics">27c6331d-8998-43aa-a382-03239013a6bd</ActivityId>
                     <ReplyTo xmlns="http://www.w3.org/2005/08/addressing">
                        <Address>http://www.w3.org/2005/08/addressing/anonymous</Address>
                    </ReplyTo>
                    <To d4p1:mustUnderstand="1" xmlns:d4p1="http://www.w3.org/2003/05/soap-envelope" xmlns="http://www.w3.org/2005/08/addressing">net.tcp://localhost/servicemodelsamples/service</To>
                  </MessageHeaders>
                  <RemoteAddress>net.tcp://localhost/servicemodelsamples/service</RemoteAddress>
                </ExtendedData>
            </TraceRecord>
          </DataItem>
       </TraceData>
   </ApplicationData>
</E2ETraceEvent>
```

## <a name="servicemodel-e2e-tracing"></a><span data-ttu-id="ea881-133">ServiceModel E2E 跟踪</span><span class="sxs-lookup"><span data-stu-id="ea881-133">ServiceModel E2E Tracing</span></span>

<span data-ttu-id="ea881-134">当 `System.ServiceModel` 跟踪源设置为 Off 而不是 `switchValue` Off 时，wcf 将 `ActivityTracing` 为 wcf 处理创建活动和传输。</span><span class="sxs-lookup"><span data-stu-id="ea881-134">When the `System.ServiceModel` trace source is set with a `switchValue` other than Off, and `ActivityTracing`, WCF creates activities and transfers for WCF processing.</span></span>

<span data-ttu-id="ea881-135">活动是一个逻辑处理单元，将与该处理单元相关的所有跟踪组合在一起。</span><span class="sxs-lookup"><span data-stu-id="ea881-135">An activity is a logical unit of processing that groups all traces related to that processing unit.</span></span> <span data-ttu-id="ea881-136">例如，可以为每个请求定义一个活动。</span><span class="sxs-lookup"><span data-stu-id="ea881-136">For example, you can define one activity for each request.</span></span> <span data-ttu-id="ea881-137">传输在终结点内的活动之间创建因果关系。</span><span class="sxs-lookup"><span data-stu-id="ea881-137">Transfers create a causal relationship between activities within endpoints.</span></span> <span data-ttu-id="ea881-138">通过传播活动 ID，可以跨终结点使活动相关。</span><span class="sxs-lookup"><span data-stu-id="ea881-138">Propagating the activity ID enables you to relate activities across endpoints.</span></span> <span data-ttu-id="ea881-139">可以通过 `propagateActivity` = `true` 在每个终结点的配置中设置来实现此目的。</span><span class="sxs-lookup"><span data-stu-id="ea881-139">This can be done by setting `propagateActivity`=`true` in configuration at every endpoint.</span></span> <span data-ttu-id="ea881-140">活动、传输和传播允许您执行错误关联。</span><span class="sxs-lookup"><span data-stu-id="ea881-140">Activities, transfers, and propagation allow you to perform error correlation.</span></span> <span data-ttu-id="ea881-141">这样，可以更快地找到错误的根本原因。</span><span class="sxs-lookup"><span data-stu-id="ea881-141">In this way, you can find the root cause of an error more quickly.</span></span>

<span data-ttu-id="ea881-142">在客户端上，为每个对象模型调用创建一个 WCF 活动（例如，打开 ChannelFactory、添加、拆分等。）每个操作调用都在 "处理操作" 活动中进行处理。</span><span class="sxs-lookup"><span data-stu-id="ea881-142">On the client, one WCF activity is created for each object model call (for example, Open ChannelFactory, Add, Divide, and so on.) Each of the operation calls is processed in a "Process Action" activity.</span></span>

<span data-ttu-id="ea881-143">在以下屏幕截图中，从[跟踪和消息日志记录](../../samples/tracing-and-message-logging.md)示例中提取了左侧面板，其中显示在客户端进程中创建的活动的列表（按创建时间排序）。</span><span class="sxs-lookup"><span data-stu-id="ea881-143">In the following screenshot, extracted from the [Tracing and Message Logging](../../samples/tracing-and-message-logging.md) sample the left panel displays the list of activities created in the client process, sorted by creation time.</span></span> <span data-ttu-id="ea881-144">以下是活动的时间顺序列表：</span><span class="sxs-lookup"><span data-stu-id="ea881-144">The following is a chronological list of activities:</span></span>

- <span data-ttu-id="ea881-145">构造了通道工厂 (ClientBase)。</span><span class="sxs-lookup"><span data-stu-id="ea881-145">Constructed the channel factory (ClientBase).</span></span>

- <span data-ttu-id="ea881-146">打开了通道工厂。</span><span class="sxs-lookup"><span data-stu-id="ea881-146">Opened the channel factory.</span></span>

- <span data-ttu-id="ea881-147">处理了加操作。</span><span class="sxs-lookup"><span data-stu-id="ea881-147">Processed the Add action.</span></span>

- <span data-ttu-id="ea881-148">设置了安全会话（这发生在第一个请求上）并处理三个安全基础结构响应消息：RST、RSTR、SCT（处理消息 1、2、3）。</span><span class="sxs-lookup"><span data-stu-id="ea881-148">Set up the Secure Session (this OCCURRED on the first request) and processed three security infrastructure response messages: RST, RSTR, SCT (Process message 1, 2, 3).</span></span>

- <span data-ttu-id="ea881-149">处理了减、乘和除请求。</span><span class="sxs-lookup"><span data-stu-id="ea881-149">Processed the Subtract, Multiply, and Divide requests.</span></span>

- <span data-ttu-id="ea881-150">关闭了通道工厂，这样做还关闭了安全会话并处理安全消息响应 Cancel。</span><span class="sxs-lookup"><span data-stu-id="ea881-150">Closed the channel factory, and doing so closed the Secure session and processed the security message response Cancel.</span></span>

 <span data-ttu-id="ea881-151">我们看到由于 wsHttpBinding 所致的安全基础结构消息。</span><span class="sxs-lookup"><span data-stu-id="ea881-151">We see the security infrastructure messages because of the wsHttpBinding.</span></span>

> [!NOTE]
> <span data-ttu-id="ea881-152">在 WCF 中，我们先在单独的活动（处理消息）中显示正在处理的响应消息，然后再将它们关联到包含请求消息的对应处理操作活动（通过传输）。</span><span class="sxs-lookup"><span data-stu-id="ea881-152">In WCF, we show response messages being processed initially in a separate activity (Process message) before we correlate them to the corresponding Process Action activity that includes the request message, through a transfer.</span></span> <span data-ttu-id="ea881-153">这发生在基础结构消息和异步请求中，并且归因于以下事实：必须检查消息、读取 activityId 标头以及识别具有该 ID 的现有“处理操作”活动以便与它相关。</span><span class="sxs-lookup"><span data-stu-id="ea881-153">This happens for infrastructure messages and asynchronous requests and is due to the fact that we must inspect the message, read the activityId header, and identify the existing Process Action activity with that id to correlate to it.</span></span> <span data-ttu-id="ea881-154">对于同步请求，我们将为响应截留这些信息，因此可以知道响应与哪个处理操作相关。</span><span class="sxs-lookup"><span data-stu-id="ea881-154">For synchronous requests, we are blocking for the response and hence know which Process action the response relates to.</span></span>

<span data-ttu-id="ea881-155">下图显示了按创建时间列出的 WCF 客户端活动（左面板）及其嵌套活动和跟踪（右上面板）：</span><span class="sxs-lookup"><span data-stu-id="ea881-155">The following image shows WCF client activities listed by creation time (left panel) and their nested activities and traces (upper right panel):</span></span>

![显示按创建时间列出的 WCF 客户端活动的屏幕截图。](./media/using-service-trace-viewer-for-viewing-correlated-traces-and-troubleshooting/wcf-client-activities-creation-time.gif)

<span data-ttu-id="ea881-157">在左面板中选择一个活动时，可以在右上面板上看到其嵌套活动和跟踪。</span><span class="sxs-lookup"><span data-stu-id="ea881-157">When we select an activity in the left panel, we can see nested activities and traces on the upper right panel.</span></span> <span data-ttu-id="ea881-158">因此，这是左侧活动列表的简化分层视图（基于所选的父活动）。</span><span class="sxs-lookup"><span data-stu-id="ea881-158">Therefore, this is a reduced hierarchical view of the list of activities on the left, based on the selected parent activity.</span></span> <span data-ttu-id="ea881-159">因为所选处理操作“加”是发出的第一个请求，所以此活动包含“设置安全会话”活动（传输到，再传输回）和对“加”操作实际处理的跟踪。</span><span class="sxs-lookup"><span data-stu-id="ea881-159">Because the selected Process action Add is the first request made, this activity contains the Set Up Secure Session activity (transfer to, transfer back from), and traces for the actual processing of the Add action.</span></span>

<span data-ttu-id="ea881-160">如果双击左面板中的 "处理操作添加" 活动，可以看到与 "添加" 相关的客户端 WCF 活动的图形表示形式。</span><span class="sxs-lookup"><span data-stu-id="ea881-160">If we double click the Process action Add activity in the left panel, we can see a graphical representation of the client WCF activities related to Add.</span></span> <span data-ttu-id="ea881-161">左侧的第一个活动是根活动 (0000)，它是默认活动。</span><span class="sxs-lookup"><span data-stu-id="ea881-161">The first activity on the left is the root activity (0000), which is the default activity.</span></span> <span data-ttu-id="ea881-162">WCF 从环境活动中传输。</span><span class="sxs-lookup"><span data-stu-id="ea881-162">WCF transfers out of the ambient activity.</span></span> <span data-ttu-id="ea881-163">如果未定义此情况，WCF 将从0000传输。</span><span class="sxs-lookup"><span data-stu-id="ea881-163">If this is not defined, WCF transfers out of 0000.</span></span> <span data-ttu-id="ea881-164">在这里，第二个活动“处理操作添加”在 0 之外传输。</span><span class="sxs-lookup"><span data-stu-id="ea881-164">Here, the second activity, Process Action Add, transfers out of 0.</span></span> <span data-ttu-id="ea881-165">然后可看到“设置安全会话”。</span><span class="sxs-lookup"><span data-stu-id="ea881-165">Then we see Setup Secure Session.</span></span>

<span data-ttu-id="ea881-166">下图显示了 WCF 客户端活动的图形视图，特别是环境活动（此处为0），处理操作，并设置安全会话：</span><span class="sxs-lookup"><span data-stu-id="ea881-166">The following image shows a graph view of WCF client activities, specifically Ambient Activity (here 0), Process action, and Set Up Secure Session:</span></span>

![跟踪查看器中显示环境活动和处理操作的关系图。](./media/using-service-trace-viewer-for-viewing-correlated-traces-and-troubleshooting/wcf-activities-graph-ambient-process.gif)

<span data-ttu-id="ea881-168">在右上面板中，可以看到与“处理操作添加”活动相关的所有跟踪。</span><span class="sxs-lookup"><span data-stu-id="ea881-168">On the upper right panel, we can see all traces related to the Process Action Add activity.</span></span> <span data-ttu-id="ea881-169">具体说来，已发送请求消息（“通过通道发送消息”）并在同一活动中收到了响应（“通过通道收到消息”）。</span><span class="sxs-lookup"><span data-stu-id="ea881-169">Specifically, we have sent the request message ("Sent a message over a channel") and received the response ("Received a message over a channel") in the same activity.</span></span> <span data-ttu-id="ea881-170">如下图所示。</span><span class="sxs-lookup"><span data-stu-id="ea881-170">This is shown in the following graph.</span></span> <span data-ttu-id="ea881-171">为清楚起见，在图形中折叠了“设置安全会话”活动。</span><span class="sxs-lookup"><span data-stu-id="ea881-171">For clarity, the Set up Secure Session activity is collapsed in the graph.</span></span>

<span data-ttu-id="ea881-172">下图显示了 "处理操作" 活动的跟踪列表。</span><span class="sxs-lookup"><span data-stu-id="ea881-172">The following image shows a list of traces for the Process Action activity.</span></span> <span data-ttu-id="ea881-173">我们发送请求并在同一活动中接收响应。</span><span class="sxs-lookup"><span data-stu-id="ea881-173">We send the request and receive the response in the same activity.</span></span>

![跟踪查看器的屏幕截图，显示 "处理操作" 活动的跟踪列表](./media/using-service-trace-viewer-for-viewing-correlated-traces-and-troubleshooting/process-action-traces.gif)

<span data-ttu-id="ea881-175">在这里，我们只是为了清楚起见加载客户端跟踪，但是，如果在工具中也加载了服务跟踪（请求消息接收和响应消息），则这些跟踪会出现在同一活动中，并 `propagateActivity` 将其设置为 `true.` 这会在后面的图中显示。</span><span class="sxs-lookup"><span data-stu-id="ea881-175">Here, we load client traces only for clarity, but service traces (request message received and response message sent) appear in the same activity if they are also loaded in the tool and `propagateActivity` was set to `true.` This is shown in a later illustration.</span></span>

<span data-ttu-id="ea881-176">在服务上，活动模型映射到 WCF 概念，如下所示：</span><span class="sxs-lookup"><span data-stu-id="ea881-176">On the service, the activity model maps to the WCF concepts as follows:</span></span>

1. <span data-ttu-id="ea881-177">构造并打开 ServiceHost（这可能创建几个与主机相关的活动，例如在出于安全性的情况下）。</span><span class="sxs-lookup"><span data-stu-id="ea881-177">We construct and open a ServiceHost (this may create several host-related activities, for instance, in the case of security).</span></span>

2. <span data-ttu-id="ea881-178">在 ServiceHost 中为每个侦听器创建“侦听”活动（包括传入和传出“打开 ServiceHost”）。</span><span class="sxs-lookup"><span data-stu-id="ea881-178">We create a Listen At activity for each listener in the ServiceHost (with transfers in and out of Open ServiceHost).</span></span>

3. <span data-ttu-id="ea881-179">当侦听器检测到由客户端启动的通信请求时，它会传输到 "接收字节" 活动，在该活动中，将处理从客户端发送的所有字节。</span><span class="sxs-lookup"><span data-stu-id="ea881-179">When the listener detects a communication request initiated by the client, it transfers to a "Receive Bytes" activity, in which all bytes sent from the client are processed.</span></span> <span data-ttu-id="ea881-180">在此活动中，可以看到在客户端-服务交互期间发生的任何连接错误。</span><span class="sxs-lookup"><span data-stu-id="ea881-180">In this activity, we can see any connection errors that have happened during the client-service interaction.</span></span>

4. <span data-ttu-id="ea881-181">对于收到的每个与消息相对应的字节集，我们将在 "处理消息" 活动中处理这些字节，我们在其中创建 WCF 消息对象。</span><span class="sxs-lookup"><span data-stu-id="ea881-181">For each set of bytes that is received that corresponds to a message, we process these bytes in a "Process Message" activity, where we create the WCF Message object.</span></span> <span data-ttu-id="ea881-182">在此活动中，可看到与错误信封或格式不正确的消息相关的错误。</span><span class="sxs-lookup"><span data-stu-id="ea881-182">In this activity, we see errors related to a bad envelope or a malformed message.</span></span>

5. <span data-ttu-id="ea881-183">形成消息后，传输到“处理操作”活动。</span><span class="sxs-lookup"><span data-stu-id="ea881-183">Once the message is formed, we transfer to a Process Action activity.</span></span> <span data-ttu-id="ea881-184">如果在客户端和服务上 `propagateActivity` 都设置为 `true`，则此活动具有与客户端中定义的活动相同的 ID，如前所述。</span><span class="sxs-lookup"><span data-stu-id="ea881-184">If `propagateActivity` is set to `true` on both the client and service, this activity has the same id as the one defined in the client, and described previously.</span></span> <span data-ttu-id="ea881-185">从这一阶段开始，我们将从跨终结点的直接关联中获益，因为在 WCF 中发出的与请求相关的所有跟踪都在同一活动中，包括响应消息处理。</span><span class="sxs-lookup"><span data-stu-id="ea881-185">From this stage we start to benefit from direct correlation across endpoints, because all traces emitted in WCF that are related to the request are in that same activity, including the response message processing.</span></span>

6. <span data-ttu-id="ea881-186">对于进程外操作，我们将创建 "执行用户代码" 活动，以将用户代码中发出的跟踪与 WCF 中发出的跟踪隔离开来。</span><span class="sxs-lookup"><span data-stu-id="ea881-186">For out-of-process action, we create an "Execute user code" activity to isolate traces emitted in user code from the ones emitted in WCF.</span></span> <span data-ttu-id="ea881-187">在前面的示例中，"服务发送添加响应" 跟踪在客户端传播的活动中（不是在适用的情况下）发出。</span><span class="sxs-lookup"><span data-stu-id="ea881-187">In the preceding example, the "Service sends Add response" trace is emitted in the "Execute User code" activity not in the activity propagated by the client, if applicable.</span></span>

<span data-ttu-id="ea881-188">在下图中，左侧的第一个活动是根活动 (0000)，它是默认活动。</span><span class="sxs-lookup"><span data-stu-id="ea881-188">In the illustration that follows, the first activity on the left is the root activity (0000), which is the default activity.</span></span> <span data-ttu-id="ea881-189">接下来的三个活动用于打开 ServiceHost。</span><span class="sxs-lookup"><span data-stu-id="ea881-189">The next three activities are to open the ServiceHost.</span></span> <span data-ttu-id="ea881-190">第 5 列中的活动是侦听器，剩余的活动（6 到 8）说明消息的 WCF 处理，从字节处理到用户代码激活。</span><span class="sxs-lookup"><span data-stu-id="ea881-190">The activity in column 5 is the listener, and the remaining activities (6 to 8) describe the WCF processing of a message, from bytes processing to user code activation.</span></span>

<span data-ttu-id="ea881-191">下图显示了 WCF 服务活动的图形视图：</span><span class="sxs-lookup"><span data-stu-id="ea881-191">The following image shows a graph view of WCF service activities:</span></span>

![显示 WCF 服务活动列表的跟踪查看器的屏幕截图](./media/using-service-trace-viewer-for-viewing-correlated-traces-and-troubleshooting/wcf-service-activities.gif)

<span data-ttu-id="ea881-193">下面的屏幕快照显示客户端和服务的活动，并突出显示跨进程的“处理操作添加”活动（橙色）。</span><span class="sxs-lookup"><span data-stu-id="ea881-193">The following screenshot shows the activities for both the client and service, and highlights the Process Action Add activity across processes (orange).</span></span> <span data-ttu-id="ea881-194">箭头使客户端和服务发送和接收的请求和响应消息相关。</span><span class="sxs-lookup"><span data-stu-id="ea881-194">Arrows relate the request and response messages sent and received by the client and service.</span></span> <span data-ttu-id="ea881-195">跨进程处理操作的跟踪在图形中单独显示，但在右上面板中作为同一活动的一部分显示。</span><span class="sxs-lookup"><span data-stu-id="ea881-195">The traces of Process Action are separated across processes in the graph, but shown as part of the same activity in the upper-right panel.</span></span> <span data-ttu-id="ea881-196">在此面板中，可以看到已发送消息的客户端跟踪，后跟已接收和已处理消息的服务跟踪。</span><span class="sxs-lookup"><span data-stu-id="ea881-196">In this panel, we can see client traces for sent messages followed by service traces for received and processed messages.</span></span>

<span data-ttu-id="ea881-197">下图显示了 WCF 客户端和服务活动的图形视图</span><span class="sxs-lookup"><span data-stu-id="ea881-197">The following images shows a graph view of both WCF client and service activities</span></span>

![跟踪查看器中显示 WCF 客户端和服务活动的关系图。](./media/using-service-trace-viewer-for-viewing-correlated-traces-and-troubleshooting/wcf-client-service-activities.gif)

<span data-ttu-id="ea881-199">在下面的错误情形中，服务和客户端上的错误和警告跟踪是相关的。</span><span class="sxs-lookup"><span data-stu-id="ea881-199">In the following error scenario, error and warning traces at the service and client are related.</span></span> <span data-ttu-id="ea881-200">在服务上的用户代码中首先引发异常（最右侧的绿色活动，包括异常“服务无法处理用户代码中的此请求。”的警告跟踪）。</span><span class="sxs-lookup"><span data-stu-id="ea881-200">An exception is first thrown in user code on the service (right-most green activity that includes a warning trace for the exception "The service cannot process this request in user code.").</span></span> <span data-ttu-id="ea881-201">将响应发送到客户端时，会再次发出警告跟踪以指示错误消息（左侧的粉红色活动）。</span><span class="sxs-lookup"><span data-stu-id="ea881-201">When the response is sent to the client, a warning trace is again emitted to denote the fault message (left pink activity).</span></span> <span data-ttu-id="ea881-202">然后客户端关闭其 WCF 客户端（左下侧的黄色活动），这将中止与服务的连接。</span><span class="sxs-lookup"><span data-stu-id="ea881-202">The client then closes its WCF client (yellow activity on the lower-left side), which aborts the connection to the service.</span></span> <span data-ttu-id="ea881-203">服务引发一个错误（右侧最长的粉红色活动）。</span><span class="sxs-lookup"><span data-stu-id="ea881-203">The service throws an error (longest pink activity on the right).</span></span>

<span data-ttu-id="ea881-204">![使用跟踪查看器](media/wcfc-e2etrace9s.gif "wcfc_e2etrace9s")</span><span class="sxs-lookup"><span data-stu-id="ea881-204">![Using the Trace Viewer](media/wcfc-e2etrace9s.gif "wcfc_e2etrace9s")</span></span>

<span data-ttu-id="ea881-205">跨服务和客户端的错误关联</span><span class="sxs-lookup"><span data-stu-id="ea881-205">Error correlation across the service and client</span></span>

<span data-ttu-id="ea881-206">用于生成这些跟踪的示例是使用 wsHttpBinding 的一系列同步请求。</span><span class="sxs-lookup"><span data-stu-id="ea881-206">The sample used to generate these traces is a series of synchronous requests using the wsHttpBinding.</span></span> <span data-ttu-id="ea881-207">对于没有安全性或具有异步请求的情形，与此图形存在偏差，其中处理操作活动包括造成异步调用的开始操作和结束操作，并显示到回调活动的传输。</span><span class="sxs-lookup"><span data-stu-id="ea881-207">There are deviations from this graph for scenarios without security, or with asynchronous requests, where the Process Action activity encompasses the begin and end operations that constitute the asynchronous call, and shows transfers to a callback activity.</span></span> <span data-ttu-id="ea881-208">有关其他方案的详细信息，请参阅[端到端跟踪方案](end-to-end-tracing-scenarios.md)。</span><span class="sxs-lookup"><span data-stu-id="ea881-208">For more information about additional scenarios, see [End-To-End Tracing Scenarios](end-to-end-tracing-scenarios.md).</span></span>

## <a name="troubleshooting-using-the-service-trace-viewer"></a><span data-ttu-id="ea881-209">使用服务跟踪查看器进行故障诊断</span><span class="sxs-lookup"><span data-stu-id="ea881-209">Troubleshooting Using the Service Trace Viewer</span></span>

<span data-ttu-id="ea881-210">在服务跟踪查看器工具中加载跟踪文件时，可以在左面板上选择任何红色或黄色的活动，以追踪应用程序中问题的原因。</span><span class="sxs-lookup"><span data-stu-id="ea881-210">When you load trace files in the Service Trace Viewer Tool, you can select any red or yellow activity on the left panel to track down the cause of a problem in your application.</span></span> <span data-ttu-id="ea881-211">000 活动通常具有最终归因于用户的未经处理的异常。</span><span class="sxs-lookup"><span data-stu-id="ea881-211">The 000 activity typically has unhandled exceptions that bubble up to the user.</span></span>

<span data-ttu-id="ea881-212">下图显示了如何选择红色或黄色活动，以找出问题的根源。</span><span class="sxs-lookup"><span data-stu-id="ea881-212">The following image shows how to select a red or yellow activity to locate the root of a problem.</span></span>
<span data-ttu-id="ea881-213">![用于查找问题根源的红色或黄色活动的屏幕截图。](./media/using-service-trace-viewer-for-viewing-correlated-traces-and-troubleshooting/service-trace-viewer.gif)</span><span class="sxs-lookup"><span data-stu-id="ea881-213">![Screenshot of red or yellow activities for locating the root of a problem.](./media/using-service-trace-viewer-for-viewing-correlated-traces-and-troubleshooting/service-trace-viewer.gif)</span></span>

<span data-ttu-id="ea881-214">在右上面板上，可以检查在左侧选择的活动的跟踪。</span><span class="sxs-lookup"><span data-stu-id="ea881-214">On the upper right panel, you can examine traces for the activity you selected on the left.</span></span> <span data-ttu-id="ea881-215">然后，可以检查该面板中的红色或黄色跟踪以及查看它们是如何相关的。</span><span class="sxs-lookup"><span data-stu-id="ea881-215">You can then examine red or yellow traces in that panel and see how they are correlated.</span></span> <span data-ttu-id="ea881-216">在前面的图形中，我们看到客户端和服务的警告跟踪都在同一处理操作活动中。</span><span class="sxs-lookup"><span data-stu-id="ea881-216">In the preceding graph, we see warning traces both for the client and service in the same Process Action activity.</span></span>

<span data-ttu-id="ea881-217">如果这些跟踪未提供错误的根本原因，则可以通过双击左面板上的所选活动（此处为处理操作）来利用图形。</span><span class="sxs-lookup"><span data-stu-id="ea881-217">If these traces do not provide you with the root cause of the error, you can utilize the graph by double-clicking the selected activity on the left panel (here Process action).</span></span> <span data-ttu-id="ea881-218">随后将显示具有相关活动的图形。</span><span class="sxs-lookup"><span data-stu-id="ea881-218">The graph with related activities is then displayed.</span></span> <span data-ttu-id="ea881-219">然后，您可以展开相关活动（通过单击 "+" 符号），在相关活动中查找红色或黄色的第一个已发出跟踪。</span><span class="sxs-lookup"><span data-stu-id="ea881-219">You can then expand related activities (by clicking the "+" signs) to find the first emitted trace in red or yellow in a related activity.</span></span> <span data-ttu-id="ea881-220">在传输到相关活动或跨终结点的消息流之后，一直展开刚好在相关的红色或黄色跟踪之前发生的活动，直到查明问题的根本原因为止。</span><span class="sxs-lookup"><span data-stu-id="ea881-220">Keep expanding the activities that happened just before the red or yellow trace of interest, following transfers to related activities or message flows across endpoints, until you track the root cause of the problem.</span></span>

<span data-ttu-id="ea881-221">![使用跟踪查看器](media/wcfc-e2etrace9s.gif "wcfc_e2etrace9s")</span><span class="sxs-lookup"><span data-stu-id="ea881-221">![Using the Trace Viewer](media/wcfc-e2etrace9s.gif "wcfc_e2etrace9s")</span></span>

<span data-ttu-id="ea881-222">展开活动以查明问题的根本原因</span><span class="sxs-lookup"><span data-stu-id="ea881-222">Expanding activities to track the root cause of a problem</span></span>

<span data-ttu-id="ea881-223">如果已关闭 ServiceModel `ActivityTracing` 但打开了 ServiceModel 跟踪，则可以看到在 0000 活动中发出的 ServiceModel 跟踪。</span><span class="sxs-lookup"><span data-stu-id="ea881-223">If ServiceModel `ActivityTracing` is off but ServiceModel tracing is on, you can see ServiceModel traces emitted in the 0000 activity.</span></span> <span data-ttu-id="ea881-224">但是，这需要进行更多的工作才能了解这些跟踪的关联。</span><span class="sxs-lookup"><span data-stu-id="ea881-224">However, this requires more effort to understand the correlation of these traces.</span></span>

<span data-ttu-id="ea881-225">如果启用了“消息日志记录”，则可以使用“消息”选项卡查看受错误影响的消息。</span><span class="sxs-lookup"><span data-stu-id="ea881-225">If Message Logging is enabled, you can use the Message Tab to see which message is impacted by the error.</span></span> <span data-ttu-id="ea881-226">通过双击红色或黄色的消息，可以看到相关活动的图形视图。</span><span class="sxs-lookup"><span data-stu-id="ea881-226">By double-clicking a message in red or yellow, you can see the graph view of the related activities.</span></span> <span data-ttu-id="ea881-227">这些活动是与发生错误的请求最紧密相关的活动。</span><span class="sxs-lookup"><span data-stu-id="ea881-227">These activities are the ones most closely related to the request where an error happened.</span></span>

![启用了消息日志记录的跟踪查看器的屏幕截图。](./media/using-service-trace-viewer-for-viewing-correlated-traces-and-troubleshooting/message-logging-enabled.gif)

<span data-ttu-id="ea881-229">若要开始进行故障排除，还可以选择红色或黄色的消息跟踪，然后双击它以跟踪根本原因。</span><span class="sxs-lookup"><span data-stu-id="ea881-229">To start troubleshooting, you can also pick a red or yellow message trace and double click it to track the root cause.</span></span>

## <a name="see-also"></a><span data-ttu-id="ea881-230">另请参阅</span><span class="sxs-lookup"><span data-stu-id="ea881-230">See also</span></span>

- [<span data-ttu-id="ea881-231">端到端跟踪方案</span><span class="sxs-lookup"><span data-stu-id="ea881-231">End-To-End Tracing Scenarios</span></span>](end-to-end-tracing-scenarios.md)
- [<span data-ttu-id="ea881-232">服务跟踪查看器工具 (SvcTraceViewer.exe)</span><span class="sxs-lookup"><span data-stu-id="ea881-232">Service Trace Viewer Tool (SvcTraceViewer.exe)</span></span>](../../service-trace-viewer-tool-svctraceviewer-exe.md)
- [<span data-ttu-id="ea881-233">跟踪</span><span class="sxs-lookup"><span data-stu-id="ea881-233">Tracing</span></span>](index.md)
